<style>
    #section1 {
        left: 147px;
        max-width: 858px;
        padding-top: 135px;
        padding-bottom: 700px;
    }

    li {
        list-style: none;
    }

    .tab_btn_area {
        overflow: hidden;
    }

    .tab_btn_area li {
        float: left;
        cursor: pointer;
        width: 196px;
        padding: 14px 10px;
        text-align: center;
    }

    .tab_btn_area li a {
        font-weight: bold;
        vertical-align: middle;
        color: #BEBCBB !important;
    }

    .tab_btn_area li.active {
        border-bottom: 2px solid #6E9357;
    }

    .tab_btn_area li.active a {
        color: #6E9357 !important;
    }

    .tab_btn_area li a:hover {
        color: #6E9357 !important;
    }

    .tab_text {
        background: #F7F7F7;
        border-radius: 10px;
        padding: 30px 40px;
        min-height: 118px;
    }

    .tab_text_null {
        background: #F7F7F7;
        border-radius: 10px;
        padding: 30px 40px;
        height: 328px;
    }

    .ggaribox_info {
        background: #F7F7F7;
        border-radius: 10px;
        padding: 23px 30px;
    }

    .btn_survey_result {
        background: #FFFFFF;
        border: 2px solid #6E9357;
        border-radius: 6px;
        width: 196px;
        padding: 10px;
        text-align: center;
        top: 6px;
        z-index: 10;
    }

    .btn_survey {
        min-width: 100%;
    }

    .small_btn {
        padding: 10px 22px;
    }

    .cart_wrap {
        padding: 0;
        border-top: 2px solid #6E9357;
        margin-left: 0;
        margin-right: 0;
        /* border-bottom: 2px solid #6E9357; */
    }

    .cart_box {
        padding: 30px 0 30px 40px;
    }

    .cart_wrap:nth-child(n+3) {
        border-top: 0;

    }

    .cart_wrap:nth-last-child(1) {
        border-bottom: 2px solid #6E9357;
    }

    .list_img {
        max-width: 90px;
        width: 90px;
        height : 90px;
    }

    .price {
        line-height: 85px;
    }

    .price2 {
        line-height: 85px;
    }

    .cart_round_box img {
        /*border: 1px solid #DBDADA;*/
        border-radius: 10px;
    }

    .cart_quantity {
        background: #F7F7F7;
        border-radius: 6px;
        padding-top: 8px;
        padding-bottom: 8px;
        max-width: 70px;
        width: 70px;
        text-align: center;
        float: left;
    }

    .small_btn2 {
        padding: 5.5px 8px;
        border-radius: 6px;
        float: left;
    }

    .btn_plus_img img,
    .btn_minus_img img {
        max-width: 20px;
        position: relative;
        top: -1.5px;
    }

    .cart_wrap2 {
        padding: 40px 94px;
    }

    .check_custom input[type=checkbox]+label {
        background-size: 24px;
        background-position-y: 0;
    }

    .cart_price{
        display: flex;        
        background: #FFFFFF;
        padding: 32px 94px;
        border-radius: 10px;
        border: 2px solid #6E9357;
        box-shadow: 0px 4px 10px rgb(0 0 0 / 10%);        
    }

    @media screen and (max-width:576px) {
        #mypage_slider{
            z-index: 200;
            position: absolute;
            top: 220px;
            width: 288px;
            left: calc((100vw - 288px)/2 );
        }

        #section1 {
            left: 0;
            padding: 0 22px;
            padding-top: 150px;
            min-height : calc(100vh - 460px);
        }

        .tab_btn li {
            width: 141px;
        }

        #tab-cont {
            padding: 0;
            min-height: 376px;
        }

        .tab_btn.pt_40px {
            padding-top: 20px;
        }

        .tab_btn_area{
            margin-top : 80px;
        }

        .tab_btn_area li {
            width : 50%;
        }

        .btn {
            font-size: 12px;
        }

        .btn_plus_img img,
        .btn_minus_img img {
            max-width: 18px;
        }

        .col-12 {
            padding-right: 0;
            padding-left: 0;
        }

        .col {
            padding-right: 0;
            padding-left: 0;
        }

        .mw_1152 {
            max-width: 288px;
            margin: 0 auto;
        }

        .cart_wrap {
            padding: 0 25px;
            padding-bottom : 10px;
        }

        .check_custom input[type=checkbox]+label {
            background-size: 18px;
            background-position-y: 0;
        }


        .cart_box .d-inline-block {
            float: left;
        }

        .cart_box .pr_15px {
            padding-right: 0;
        }

        .small_btn {
            padding: 4px 14px;
        }

        .cart_box .mt_12px {
            margin-top: 10px;
        }

        .cart_box {
            padding: 20px 0;
        }

        .list_img {
            display: none;
        }

        .price {
            line-height: 1.5;
            padding: 0;
            position: absolute;
            right : 0px;
            top : 58px;
        }

        .price2 {
            line-height: 1.5;
            padding: 35px 0 24px 0;
        }

        .itemmm_name {
            display: block;
            padding-left: 0;
            overflow: hidden;
            width : 200px;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cart_quantity {
            padding-top: 6px;
            padding-bottom: 6px;
            max-width: 48px;
            width: 48px;
            margin-left: 0;
        }

        .small_btn2 {
            padding: 3px 5px;
        }

        .ml_10px {
            margin-left: 0;
        }

        .cart_wrap2 {
            padding: 30px 25px;
        }

        .tab_text .float-right {
            float: none!important;
        }
        .tab_text {                
            padding: 30px 30px;
        }
        .btn_survey_result {
            width: 228px;
        }
        .btn1_1 {
            width: 208px;
        }

        .btn_mobile .btn_minus_img.mr_30px {
            margin-right: 0;
        }

        .m_btn_100 {    
            width: 100%;
            margin-top: 20px;
        }

        .btn_mypagetab {
            width: 8px;
            margin-right: 12px;
            top: -1px;
        }

        .cart_price{
            padding: 27px 25px;
            margin-top:20px;            
        }
        .cart_text_box{
            width : 220px;
        }

    }
</style>

<div id="mypage_slider" class="pt_30px mobile fs_18 fw_700 point_color btn_mypage" onclick="catPage.slideSidebar()">
    <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/catname_swiper_left.png" alt="" class="img-fluid btn_mypagetab">
    <span id="mobile_return_text">돌아가기</span>
</div>


<div class="container-fluid" id="section1">
    <div class="row mw_1152">
        <div class="col">
            <div class="fs_28 fw_700 "><span class="point_color cat_name"></span> 반려묘 정보</div>            
            <div class="tab_btn_area pt_40px">
                <ul>
                    <li id="tab_btn1" class="tab_btns active fs_18 fw_700" onclick="catPage.tabButton(1)">
                        <a>설문조사 기록</a>
                    </li>
                    <li id="tab_btn2" class="tab_btns fs_18 fw_700" onclick="catPage.tabButton(2)">
                        <a>까리박스 구성 정보</a>
                    </li>
                </ul>
            </div>
            <div id="tab-1" class="tabs">
                <!--값 있을때-->                
                <div id="survey_exist">
                </div>
                <!--값 없을때-->
                <div id="survey_exist_not" class="tab_text_null">
                    <div class="row align-items-center h-100 text-center">
                        <div class="col">
                            <div class="fs_18 fw_700 point_color">설문조사 기록이 없습니다</div>
                            <div class="pt_10px fs_14 sub_gray_text">질문을 통해 내 반려묘에게 꼭 필요한 영양 간식을 알아보세요.</div>
                            <button class="btn btn-success fw_700 btn_survey mt_40px" onclick="location.href='/page/?M2_IDX=26434';">설문조사 하러가기</button>
                        </div>
                    </div>
                </div>
            </div>    

            <div id="tab-2" class="tabs">

                    <!--값 있을때 -->
                <div id="inbox_exist" class="tab_text2 d-none">
                    <div class="ggaribox_info fw_700">
                        해당 리스트는 <span class="point_color">매달 정기배송될 제품들</span>입니다. <span class="point_color">당월
                            1회만 구입하고 싶은 제품은 장바구니</span>에서 추가하세요.
                    </div>
                    
                    <div id="cart_boxes" class="cart_wrap">
                    </div>
                    <div class="cart_price">
                        <div class="col pr-0">
                            <div class="fs_20 fw_700 float-left point_color">합계</div>
                            <div id="total_price" class="fs_20 fw_700 float-right point_color"></div>
                        </div>
                    </div>
                    <div class="row mw_1152 btn_mobile">
                        <div class="col-12 pt_30px px-0">
                            <button type="button" class="btn btn-outline-success fw_700 btn1_1" onclick="catPage.gotoDiagnosis()">
                                추천 제품 다시 선택
                            </button>    
                            <button type="button" class="btn btn-outline-success fw_700 float-right btn_minus_img btn_minus_txt mr_30px mobile" onclick="catPage.postDeleteItem()">
                                <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/trash_ico.png" alt="" class="img-fluid">
                                <span>선택 삭제</span>
                            </button>
                            <button type="button" class="btn btn-success fw_700 float-right px-5 m_btn_100" onclick="catPage.postEdit()">
                                <span>변경 완료</span>
                            </button>
                            <button type="button" class="btn btn-outline-success fw_700 float-right btn_minus_img btn_minus_txt mr_30px pc" onclick="catPage.postDeleteItem()">
                                <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/trash_ico.png" alt="" class="img-fluid">
                                <span>선택 삭제</span>
                            </button>
                        </div>
                    </div>
                </div>


                <!--값 없을때 -->
                <div id="inbox_exist_not" class="tab_text_null">
                    <div class="row align-items-center h-100 text-center">
                        <div class="col">
                            <div class="fs_18 fw_700 point_color">까리박스 구성 정보가 없습니다</div>
                            <div class="pt_10px fs_14 sub_gray_text">지금 까리박스를 구독하시면 배송비 무료, 구독 할인 등 많은 혜택을 받을 수
                                있습니다.</div>

                            <button class="btn btn-success fw_700 btn_survey mt_40px"
                                onclick="location.href='/page/?M2_IDX=26434';">설문조사 하러가기</button>
                        </div>
                    </div>
                </div>
                

                

            </div>


        </div>
    </div>
</div>

<script>
$(()=>{    
    $(window).resize(()=> {
        if (util.checkMobile()) {  // 다바이스가 모바일일 때 
            $(document).ready(() => { changeIMG(); });
            function changeIMG() {
                $(".btn_minus_txt img").attr("src", "https://ggaribox.s3.ap-northeast-2.amazonaws.com/btn_minus_ico.png");
                $(".btn_minus_txt span").text("제품 삭제하기");
                $(".btn_minus_txt img").addClass("mr-2");
                $(".btn_minus_txt").css("padding", "14px 22px");
                $(".list_img").removeClass("d-none");
                $(".cart_order_btn img").attr("src", "https://ggaribox.s3.ap-northeast-2.amazonaws.com/cart_order_btn.png");
            }
        } else {
            $(document).ready(() => { changeIMG(); });
            function changeIMG() {
                $(".btn_minus_txt img").attr("src", "https://ggaribox.s3.ap-northeast-2.amazonaws.com/trash_ico.png");
                $(".btn_minus_txt span").text("");
                $(".btn_minus_txt img").removeClass("mr-2");
                $(".btn_minus_txt").css("padding", "14px 16px");
                $(".list_img").addClass("d-none");
                $(".cart_order_btn img").attr("src", "https://ggaribox.s3.ap-northeast-2.amazonaws.com/cart_order_btn_m.png");
            }
        }
    }).resize();


    $('.mycat_namebox').click(function(){
        $('#sidebar6').css('left','-9999px');
    });

    $('.btn_mypage').click(function(){
        $('#sidebar6').css('left','0');
    });

});

var catPage = {
    id : null,
    idRecord : null,
    surveys: {},
    extends : [],
    products : [],
    deleteIds : [],
    edits : {},
    isSideOn : true,
    totalPrice : 0,

    init : () => {        
        catPage.id = util.getParamFromUrl('id');
        if(catPage.id == undefined){
            let pr = cat.getCatsData();
            $.when(pr).then(()=>{
                catPage.id = cat.cats[0].id;
                catPage.getMySurveys();
                catPage.getMySubscribes();
            });
        }else{
            if(util.checkMobile()) catPage.slideSidebar();
            catPage.getMySurveys();
            catPage.getMySubscribes();
        }
        catPage.tabButton(1);
        if(util.checkMobile()){
            catPage.slideSidebar();
        }

        if(util.getParamFromUrl('mode') == 2){
            catPage.tabButton(2);
        }
    },
    
    getMySurveys : ()=>{
        $.ajax(util.getAjaxSetting(serverUrl+"/api/cat/diseases/olly/"+user.id))
        .done((data)=>{
            $.each(data, (i, item)=> {
                if(!catPage.surveys.hasOwnProperty(item.id_cat)){
                    catPage.surveys[item.id_cat] = {};
                }
                if(!catPage.surveys[item.id_cat].hasOwnProperty(item.round)){
                    catPage.surveys[item.id_cat][item.round] = [];
                }
                
                catPage.surveys[item.id_cat][item.round].push(item);
            });
            console.log(catPage.surveys);
            catPage.drawCatPage();
        }).fail((jqXHR, textStatus, errorThrown)=>{
            console.log('No Cat Here!' + textStatus + " : " + errorThrown);
        });
    },

    getMySubscribes : ()=>{
        let extend;
        let ollyShop;
        let pr1 = $.ajax(util.getAjaxSetting(serverUrl+"/api/subscribe/"+catPage.id)
        ).done((data)=>{
            if(data.length != 0){
                catPage.idRecord = data[0].id;
                catPage.extends = data[0].items;
                console.log(data);
            }
        }).fail((jqXHR, textStatus, errorThrown)=>{
            console.log('No Cat Here!' + textStatus + " : " + errorThrown);
        });

        var pr2 = $.ajax({
            url: '/api/shop.list.php',
            type: "POST",
            async : false,
            data: {
                "KEY": apikey,
                menu2_id: "26044",
                menu2_id : "26044",
                use_page : false,
                use_limit : false,
            },
        }).done((data) => {
            ollyShop = data.items;
        }).fail((jqXHR, textStatus, errorThrown) => {
            console.log(errorThrown)
        });

        $.when(pr1, pr2).done(()=>{
            $.each(catPage.extends, (i, item)=>{
                if(item.extended.id_olly_product != null){
                    Object.assign(item, ollyShop.find(e=> e.product_code == item.extended.id_olly_product));
                }
                catPage.products.push(item);
            });

            console.log(catPage.products);
            catPage.drawGgaribox();
        });
    },

    tabButton : (index)=>{
        $('.tab_btns').removeClass('active');
        $('#tab_btn'+index).addClass('active');
        $('.tabs').addClass('d-none');
        $('#tab-'+index).removeClass('d-none');
    },

    count : (id, isPlus)=>{
        const $quantity = $('#amount'+id);
        let quantity = parseInt($quantity.html());
        let price = catPage.products.find(e=> e.id == id).product_price;
        let oldPrice = parseInt($('#price'+id).html().replace('￦', '').replace(',', ''));

        if(!catPage.edits.hasOwnProperty(id)){
            catPage.edits[id] = catPage.products.find(e=> e.id == id).amount_user_added;
        }        
        if(isPlus){
            quantity++;
            catPage.edits[id]++;
            catPage.totalPrice += price;
            $('#price'+id).html(util.won3Comma(oldPrice + price));
        }else{
            if(quantity != 0){
                quantity--;
                catPage.edits[id]--;
                catPage.totalPrice -= price;
                $('#price'+id).html(util.won3Comma(oldPrice - price));
            }
        }
        console.log(catPage.edits);
        $quantity.html(quantity);
        $('#total_price').html(util.won3Comma(catPage.totalPrice));
    },

    drawCatPage : ()=>{
        $('.cat_name').html(cat.cats.find(e=> e.id == catPage.id).name+" ");

        $('.mycat_namebox[data-id='+catPage.id+']').addClass('active');
        let $exist = $('#survey_exist');
        let $origin = $('#origin_survey_box');
        let exist = false;

        if(!util.isEmpty(catPage.surveys[catPage.id])){
            if(Object.keys(catPage.surveys[catPage.id]).length != 0){
                exist = true;
            }
        }
        if(exist){
            $('#survey_exist_not').addClass('d-none');
            $.each(catPage.surveys[catPage.id], (i, item)=>{
                let $box = $origin.clone().removeClass('d-none').attr('id', 'survey_round'+item[0].round);
                $box.find('span').eq(0).html("#"+ util.getDisStr(item[0].id_diseases));
                $box.find('span').eq(1).html("#"+ util.getDisStr(item[1].id_diseases));
                $box.find('span').eq(2).html("#"+ util.getDisStr(item[2].id_diseases));
                $box.find('button').click(()=>{location.href="/page/?M2_IDX=26046&id="+item[0].id_cat+"&round="+item[0].round });
                $box.find('div').html(item[0].createdAt.substr(0, 10));
                $exist.append($box);
            });
        }else{
            $('#survey_exist').addClass('d-none');
            $('#survey_exist_not').removeClass('d-none');
        }
        $origin.remove();
    },

    drawGgaribox : ()=>{
        if(catPage.products.length !=0){
            $('#inbox_exist_not').addClass('d-none');
            $('#inbox_exist').removeClass('d-none');
            let $carts = $('#cart_boxes');
            let $originbox = $('#origin_inbox');
            $.each(catPage.products, (i, item)=>{
                let $box = $originbox.clone().removeClass('d-none').attr('id', 'cart'+item.id);
                $box.find('.list_img').attr('src', item.img).removeClass('d-none');                
                $box.find('.category').html(item.category2_name);
                $box.find('.itemmm_name').html( item.product_name);
                $box.find('input').attr({name:'delete'+item.id, id:'delete'+item.id});
                $box.find('label').attr({for:'delete'+item.id});              
                let amount = item.amount + item.amount_user_added;
                $box.find('.price').attr('id', 'price'+item.id).html(util.won3Comma(item.product_price * amount));  
                catPage.totalPrice += parseInt(item.product_price) * amount;
                $box.find('.cart_quantity').attr('id', 'amount'+item.id).html(amount);
                $box.find('.btn_plus_img').click(()=>{catPage.count(item.id, true)});
                $box.find('.btn_minus_img').click(()=>{catPage.count(item.id, false)});
                $carts.append($box);
            });
            $originbox.remove();
            $('#total_price').html(util.won3Comma(catPage.totalPrice));
        }else{
            $('#inbox_exist').addClass('d-none');
            $('#inbox_exist_not').removeClass('d-none');
        }
    },
    
    gotoDiagnosis : () => {        
        location.href = '/page/?M2_IDX=26046&id='+catPage.id;
    },

    postDeleteItem : ()=>{
        let $deletes = $('input[type=checkbox]:checked');
        if($deletes.length == 0 ){
            alert('삭제할 상품을 골라주세요.');
            return false;
        }
        let ids = [];
        $.each($deletes, (i, item)=>{            
            ids.push($(item).attr('id').replace(/[^0-9]/g, ""));
        });
        console.log(ids);

        $.ajax({
            url : serverUrl +"/api/subscribe/item/",
            type : "DELETE",
            data : {
                ids : ids.toString()
            }
        }).done((data)=>{
            console.log(data);
            alert ('삭제되었습니다.');
            location.href="/page/?M2_IDX=26922&id="+catPage.id;
        }).fail((jqXHR, textStatus, errorThrown) => {
            console.log("DELETE FAIL", errorThrown)            
        });

    },

    postEdit : () => {
        if(catPage.edits.length == 0){
            alert('반영할 변경사항이 없습니다.');
            return false;
        }
        
        $.ajax({
            url : serverUrl+"/api/subscribe/item/",
            type : "PATCH",
            data : {
                id : catPage.idRecord,
                total_price : catPage.totalPrice,
                edits : JSON.stringify(catPage.edits),
            }
        }).done((data)=>{
            alert('내용이 변경되었습니다.')
            location.href="/page/?M2_IDX=26922&id="+catPage.id;
        }).fail((jqXHR, textStatus, errorThrown) => {
            console.log(errorThrown)
        });
    },

    //임시방책. 나중에 플로 다시 확인해야함. 피그마에 플로 없음.
    slideSidebar : ()=> {
        let xPos;
        if(catPage.isSideOn){
            catPage.isSideOn = false;
            xPos = $('#sidebar6').width()+100;
        }else{
            catPage.isSideOn = true;
            xPos = 0;
        }
        $('#sidebar6').animate({left : -xPos}, 0);            
    },

}
</script>

<div id="origin_survey_box" class="tab_text mt_20px d-none">
    <span class="point_color fw_700 pr_10px"></span>
    <span class="point_color fw_700 pr_10px"></span>
    <span class="point_color fw_700 pr_10px"></span>
    <button class="float-right btn_survey_result fs_14 point_color fw_700">설문조사 결과보기</button>
    <div class="pt_10px sub_gray_text">2022-08-08</div>
</div>

<div id="origin_inbox" class="row mt_20px d-none">
    <div class="col">
        <div class="cart_box">
            <div class="d-inline-block align-middle pr_15px">
                <div class="check_custom">
                    <input type="checkbox" name="select_chk01" id="select_chk01">
                    <label for="select_chk01">&nbsp;</label>
                </div>
            </div>
            <div class="d-inline-block align-middle pr_30px cart_round_box">
                <img src="" alt="" class="img-fluid list_img">
            </div>

            <div class="d-inline-block align-middle">
                <div class="fs_18 fw_700 mb_12px">
                    <span class="category"></span>
                    <span class="fw_400 sub_gray_text pl_20px itemmm_name"></span>
                </div>
                <button type="button" class="btn btn-outline-success small_btn2 ml_10px btn_minus_img" value="-">
                    <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/btn_minus_ico.png" alt="" class="img-fluid">
                </button>
                <div class="cart_quantity ml_10px"></div>
                <button type="button" class="btn btn-outline-success small_btn2 btn_plus_img" value="+">
                    <img src="https://ggaribox.s3.ap-northeast-2.amazonaws.com/btn_plus_ico.png" alt="" class="img-fluid">
                </button>
            </div>
            <div class="d-inline-block align-middle float-right price2 pr_2rem text-right">
                <div class="fs_20 fw_700 point_color price"></div>
            </div>
        </div>
    </div>
</div>
